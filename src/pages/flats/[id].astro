---
import Layout from "../../layouts/Layout.astro";
import type {
  FlatDto,
  PaymentTypesResponseDto,
  PaymentsResponseDto,
  FlatDetailViewModel,
} from "../../types";
import { transformFlatDetailData } from "../../lib/flat-detail-transformers";
import FlatDetailHeader from "../../components/FlatDetailHeader";

export const prerender = false;

// Get flat ID from URL params
const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/dashboard");
}

// Validate UUID format (basic check)
const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
if (!uuidRegex.test(id)) {
  return Astro.redirect("/dashboard");
}

// Fetch flat details
let flat: FlatDto;
try {
  const flatResponse = await fetch(`${Astro.url.origin}/api/flats/${id}`, {
    headers: {
      Cookie: Astro.request.headers.get("Cookie") || "",
    },
  });

  if (!flatResponse.ok) {
    if (flatResponse.status === 404) {
      return Astro.redirect("/dashboard?error=flat_not_found");
    }
    if (flatResponse.status === 401) {
      return Astro.redirect("/login");
    }
    throw new Error("Failed to fetch flat");
  }

  flat = await flatResponse.json();
} catch (error) {
  console.error("Error fetching flat:", error);
  return Astro.redirect("/dashboard?error=fetch_failed");
}

// Fetch payment types
let paymentTypesData: PaymentTypesResponseDto;
try {
  const paymentTypesResponse = await fetch(
    `${Astro.url.origin}/api/flats/${id}/payment-types`,
    {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    }
  );

  if (!paymentTypesResponse.ok) {
    throw new Error("Failed to fetch payment types");
  }

  paymentTypesData = await paymentTypesResponse.json();
} catch (error) {
  console.error("Error fetching payment types:", error);
  paymentTypesData = { payment_types: [] };
}

// Fetch payments (default: unpaid only)
let paymentsData: PaymentsResponseDto;
try {
  const paymentsResponse = await fetch(
    `${Astro.url.origin}/api/flats/${id}/payments?is_paid=false`,
    {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    }
  );

  if (!paymentsResponse.ok) {
    throw new Error("Failed to fetch payments");
  }

  paymentsData = await paymentsResponse.json();
} catch (error) {
  console.error("Error fetching payments:", error);
  paymentsData = { payments: [] };
}

// Transform data to view model
const viewModel: FlatDetailViewModel = transformFlatDetailData(
  flat,
  paymentTypesData.payment_types,
  paymentsData.payments
);
---

<Layout title={`${flat.name} - Flats Manager`}>
  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm">
      <ol class="flex items-center space-x-2 text-muted-foreground">
        <li>
          <a href="/dashboard" class="hover:text-foreground transition-colors">
            Dashboard
          </a>
        </li>
        <li>
          <span class="mx-2">/</span>
        </li>
        <li>
          <a href="/dashboard" class="hover:text-foreground transition-colors">
            Flats
          </a>
        </li>
        <li>
          <span class="mx-2">/</span>
        </li>
        <li class="text-foreground font-medium">{flat.name}</li>
      </ol>
    </nav>

    <!-- Flat Detail Header -->
    <FlatDetailHeader flat={flat} client:load />

    <!-- Overview Section -->
    <section class="mb-8">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Total Debt Card -->
        <div class="bg-card text-card-foreground rounded-lg border p-6">
          <h3 class="text-sm font-medium text-muted-foreground mb-2">Total Debt</h3>
          <p class="text-3xl font-bold">
            {new Intl.NumberFormat("pl-PL", {
              style: "currency",
              currency: "PLN",
            }).format(viewModel.stats.totalDebt)}
          </p>
        </div>

        <!-- Payment Types Count Card -->
        <div class="bg-card text-card-foreground rounded-lg border p-6">
          <h3 class="text-sm font-medium text-muted-foreground mb-2">Payment Types</h3>
          <p class="text-3xl font-bold">{viewModel.stats.paymentTypesCount}</p>
        </div>

        <!-- Pending Payments Count Card -->
        <div class="bg-card text-card-foreground rounded-lg border p-6">
          <h3 class="text-sm font-medium text-muted-foreground mb-2">Pending Payments</h3>
          <p class="text-3xl font-bold">{viewModel.stats.pendingPaymentsCount}</p>
        </div>
      </div>
    </section>

    <!-- Payment Types Section (placeholder) -->
    <section class="mb-8">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Payment Types</h2>
        <button class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90">
          Add Payment Type
        </button>
      </div>
      <div class="bg-card text-card-foreground rounded-lg border p-6">
        <p class="text-muted-foreground">Payment types table will be implemented in next step</p>
      </div>
    </section>

    <!-- Payments Section (placeholder) -->
    <section>
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Payments</h2>
        <button class="px-4 py-2 bg-primary text-primary-foreground rounded-md hover:bg-primary/90">
          Generate Payments
        </button>
      </div>
      <div class="bg-card text-card-foreground rounded-lg border p-6">
        <p class="text-muted-foreground">Payments table will be implemented in next step</p>
      </div>
    </section>
  </main>
</Layout>

